---
title: "Skin Microbiome"
author: "Jay T. Lennon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## 1) Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list = ls())
getwd()
setwd("~/GitHub/skin")
```

## 2) Load data
```{r}
# Load raw data
ctc <- read.table("data/skin.isolate.CTC.txt", sep = "\t", header = TRUE)

# Look at raw data structure
str(ctc)
```

## 3) Subsetting Data
```{r}
# treatment info
treat <- cbind(as.data.frame(ctc$Strain), ctc$Rep, ctc$Treat)

# cells with no CTC
minus <- ctc[ctc$Treat == "minus",]

# killed cells with CTC
kill <- ctc[ctc$Treat == "kill",]

# cells incubated with CTC
plus <- ctc[ctc$Treat == "plus",]
```

## 4) Correcting and making new dataframe
```{r}
# Correct dtat by controls

# kill-corrected
kill.corr <- kill$Fluor - minus$Fluor

# plus-corrected
plus.corr <- plus$Fluor - minus$Fluor

# Create strains vector
strains <- c("K1", "K1", "K1", "K2", "K2", "K2", "K3", "K3", "K3",
             "F1", "F1", "F1", "F2", "F2", "F2", "B1", "B1", "B1", "K4",
             "K4", "K4", "K5", "K5","K5", "K6", "K6","K6","EC","EC", "EC")

# Merge into new data frame
data.corr <- as.data.frame(cbind(strains, kill.corr, plus.corr))
data.corr$kill.corr <- as.numeric(as.character(data.corr$kill.corr))
data.corr$plus.corr <- as.numeric(as.character(data.corr$plus.corr))
as.data.frame(data.corr)
```

## 5) Multiple paired t-test
```{r}
# Create output matrix for summary statistics
test.out <- matrix(data =NA, length(levels(data.corr$strains)), 3)
row.names(test.out) <- c("K1", "K2", "K3", "F1", "F2", "B1", "K4", "K5", "K6", "EC")
colnames(test.out) <- c("t.value", "df", "p.value")

# For loop to run t-tests
for(i in levels(data.corr$strains)) {
  tmp = data.corr[data.corr$strains == i,]
  test = t.test(tmp$kill.corr, tmp$plus.corr, paired = TRUE)
  test.out[i, "t.value"] <- test$statistic
  test.out[i, "df"] <- test$parameter
  test.out[i, "p.value"] <- test$p.value
  }

# Benjamini & Hochberg correction for multiple comparisons
p.adjust <- p.adjust(test.out[,3], method = "BH", n = length(test.out[,3]))

# Final output matrix with corrected p-values
test.out.final <- cbind(test.out, p.adjust) 
# For loop to run t-tests
```
  
## 6) Means and figure

  

  
  
  
  
  
sub<- as.data.frame(data.corr[1:3,])
t.test(sub$kill.corr, sub$plus.corr, paired = TRUE)


t.result <- apply(data.corr[,2:3], 1, t.test)



t.test(data.corr$kill.corr, data.corr$plus.corr)

mapply(t.test, data.corr$kill.corr, data.corr$plus.corr, paired = TRUE)
```

## 5) Regressions with all data

# biomass via absorbance (minus CTC)
biomass.minus <- minus$Abs
fit1 <- lm(plus.corr ~ biomass.minus)
plot(biomass.minus, plus.corr)
abline(fit1)

# biomass via absorbance (plus CTC)
biomass.plus <- plus$Abs
fit2 <- lm(plus.corr ~ biomass.plus)
plot(biomass.plus, plus.corr)
abline(fit2)
```


## 6) Correcting data and regressions with means
```{r}

plus.mean <- aggregate(plus$Fluor, list(plus$Strain), FUN=mean, na.rm=TRUE)
cont.mean <- aggregate(minus$Fluor, list(minus$Strain), FUN=mean, na.rm =TRUE)
corr.mean <- plus.mean[,2]-cont.mean[,2]

biomass.minus.mean <- aggregate(minus$Abs, list(minus$Strain), FUN=mean, na.rm =TRUE)
biomass.plus.mean <- aggregate(plus$Abs, list(plus$Strain), FUN=mean, na.rm =TRUE)

# biomass via absorbance (minus CTC)
fit3 <- lm(corr.mean ~ biomass.minus.mean[,2])
plot(biomass.minus.mean[,2], corr.mean)
abline(fit3)

# biomass via absorbance (plus CTC)
fit4 <- lm(corr.mean ~ biomass.plus.mean[,2])
plot(biomass.plus.mean[,2], corr.mean)
abline(fit4)

## 4) Run t-test by strain
strains <- unique(ctc$Strain)
strains <- rep(strains, each = 3)
reps <- rep(seq(1,3), 10)
data <- cbind(as.data.frame(strains), reps, kill.corr, plus.corr)

apply(data,1,)

