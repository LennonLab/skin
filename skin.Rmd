---
title: "Skin Microbiome"
author: "Honors Thesis Student: Sarah Cummins; Advisor: Jay Lennon"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
   - \usepackage{array}
output: pdf_document
geometry: margin=2.54cm
---

## 1) SETUP
### A. Retrieve and Set Your Working Directory

```{r, results = 'hide'}
rm(list = ls())
getwd()
setwd("~/GitHub/skin")
```

### B. Load Packages 
```{r}
require("vegan")
```

## 2) ANALYSIS OF DIFFERENT HABITATS

### A. Load data
```{r}
# Load raw data
hab <- read.table("skin.habitat.txt", sep = "\t", header = TRUE)

# Look at raw data structure
str(hab)
```

### B. Calculate percentages of each metabolic class
```{r}
# Percent active, dead, and dormanc
act.per <- hab$active/hab$total
dead.per <- hab$dead/hab$total  
dorm.per <- hab$dormant/hab$total

# Make new dataframe with percent metabolic class data
hab.per <- data.frame(hab[1:2], act.per, dorm.per, dead.per)
```

### C. Make a summary table for metabolic classes by habitat
```{r}
sem <- function(x){
  sd(x)/sqrt(length(x))
  }

table <- aggregate(hab.per[, c("act.per", "dead.per", "dorm.per")], 
            by = list(hab.per$habitat), function(x) c(mean=mean(x), sem=sem(x)))
colnames(table) <- c("habitat", "active", "dead","dormant")

print(table)
```

### D. Make stacked bar chart for each subject and differen habitats
```{r}
back <- subset(hab.per, habitat == "back")
back.sub <- t(back[,c(5,4,3)])
colnames(back.sub) <- 1:10

arm <- subset(hab.per, habitat == "arm")
arm.sub <- t(arm[,c(5,4,3)])
colnames(arm.sub) <- 1:10

knee <- subset(hab.per, habitat == "knee")
knee.sub <- t(knee[,c(5,4,3)])
colnames(knee.sub) <- 1:10

par(mfrow = c(1,1), mar = c(1,7,2,5.5))
bar.layout <- layout(rbind(1, 2, 3, 4), height = c(4, 4, 5, 1)) 
#layout.show(bar.layout)

barplot.back <- barplot(as.matrix(back.sub),
        ylim = c(0, 1), las = 1,
        beside = FALSE,
        cex.axis = 1.5,
        axisnames = FALSE,
        col = c("darkblue", "red", "yellow"), plot = TRUE)
mtext("Back", side = 4, las = 1, cex = 1.5, adj = 0, line = -1)

par(mar = c(1, 7, 1, 5.5))

barplot.arm <- barplot(as.matrix(arm.sub),
        ylim = c(0, 1), las = 1,
        beside = FALSE,
        cex.axis = 1.5,
        axisnames = FALSE,
        col = c("darkblue", "red", "yellow"), plot = TRUE)
mtext("Proportion", side = 2, line = 4, cex = 2)
mtext("Arm", side = 4, las = 1, cex = 1.5, adj = 0, line = -1)

par(mar = c(5, 7, 1, 5.5))
barplot.knee <- barplot(as.matrix(knee.sub),
        ylim = c(0, 1), las = 1,
        beside = FALSE,
        cex.axis = 1.5,
        xlab = "Subjects", cex.lab = 2, cex.names = 1.5,
        axisnames = TRUE, 
        col = c("darkblue", "red", "yellow"), plot = TRUE)
mtext("Knee", side = 4, las = 1, cex = 1.5, adj = 0, line = -1)

par(mar=c(0, 9, 0, 0))
plot.new()
legend("center", c("Active","Dormant","Dead"), pt.lwd = 2, col = "black", 
      pt.bg = c("yellow","red", "darkblue"), pch = c(22, 22, 22), bty='n',
      ncol = 3, cex = 2, pt.cex = 5)
```

### E. SINGLE ANOVAs: do habitats vary in classes of activity?
```{r}
# Make a factor table for habitats
hab.type <- hab.per$habitat

# ANOVA for active "are "
anova.act <- aov(act.per ~ hab.type)
summary(anova.act)
TukeyHSD(anova.act)

anova.dorm <- aov(dorm.per ~ hab.type)
summary(anova.dorm)
TukeyHSD(anova.dorm)

anova.dead <- aov(dead.per ~ hab.type)
summary(anova.dead)
TukeyHSD(anova.dead)
```

### C. Test for differences among habitats using PERMANOVA
```{r}
# Subset activity data
hab.per.cell <- hab.per[,3:5]
hab.type <- hab.per$habitat
subjects <- hab.per$subject

# Run PERMANOVA with adonis function blocking by subject
adonis(hab.per.cell ~ hab.type, method = "bray", permutations = 999, strata = subjects) 
```

## 3) ANALYSIS OF DIFFERENT AGES

### A. Load data
```{r}
# Load raw data
ages.raw <- read.table("skin.age.txt", sep = "\t", header = TRUE)

# Remove potential outlier
ages <- ages.raw[ ! ages.raw$subject == "G1", ]

# Look at raw data structure
str(ages)

# Notes on "hygiene" variables, which include:
    # "last.show" = last time you showered?
            #1 = more than 48 hrs ago, 
            #2 = 24 - 48 hrs ago,
            # 3 = less than 24 hrs ago
    # "show.freq" = when is the last time you showered?
           #1 = less than 3 times per week
           #2 = every other day
           #3 = once per day
    # "show. leng" = how long is your typical shower
           #1 = 0-5 mins
           #2 = 5-15 mins
           #3 = more than 15 mins
# JTL modified the the scale of the original data so that higher numbers
# euate with "more" hygiene
```

### B. Create factors
```{r}
gender <- as.factor(ages$gender)
last.show <- as.factor(ages$last.show)
show.freq <- as.factor(ages$show.freq)
show.leng <- as.factor(ages$show.leng)
pet <- as.factor(ages$pet)
anti <- as.factor(ages$anti)
ecze <- as.factor(ages$ecze)
alle <- as.factor(ages$alle)
tan <- as.factor(ages$tan)
etoh <- as.factor(ages$etoh)
```

### C. Reduce hygiene data using PCoA (needs to be revisited)
```{r}
show.dat <- ages[,8:10]
show.dist <- vegdist(show.dat, method = "bray")
show.pcoa <- cmdscale(show.dist, eig = TRUE, k = 2) 

explainvar1 <- round(show.pcoa$eig[1] / sum(show.pcoa$eig), 3) * 100
explainvar2 <- round(show.pcoa$eig[2] / sum(show.pcoa$eig), 3) * 100
explainvar3 <- round(show.pcoa$eig[3] / sum(show.pcoa$eig), 3) * 100
sum.eig <- sum(explainvar1, explainvar2, explainvar3)

# Define Plot Parameters
par(mar = c(5, 5, 1, 2) + 0.1)

# Initiate Plot
plot(show.pcoa$points[ ,1], show.pcoa$points[ ,2], ylim = c(-1, 1),
     xlab = paste("PCoA 1 (", explainvar1, "%)", sep = ""),
     ylab = paste("PCoA 2 (", explainvar2, "%)", sep = ""),
     pch = 16, cex = 2.0, type = "n", cex.lab = 1.5, cex.axis = 1.2, axes = FALSE)

# Add Axes
axis(side = 1, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
axis(side = 2, labels = T, lwd.ticks = 2, cex.axis = 1.2, las = 1)
abline(h = 0, v = 0, lty = 3)
box(lwd = 2)

# Add Points & Labels
points(show.pcoa$points[ ,1], show.pcoa$points[ ,2],
       pch = 19, cex = 3, bg = "gray", col = "gray")
text(show.pcoa$points[ ,1], show.pcoa$points[ ,2], 
     labels = row.names(show.pcoa$points))
PC1 <- show.pcoa$points[,1]
PC2 <- show.pcoa$points[,2]
```

### D. Calculate percent activity
# Percent active, dead, and dormanc
```{r}
act.p <- ages$active / ages$total
dead.p <- ages$dead / ages$total  
dorm.p <- ages$dormant / ages$total
viab.p <- (ages$active + ages$dormant) / ages$total
act.dorm.p <- ages$active / (ages$active + ages$dormant)

# Make new dataframe with percent metabolic class data
age.per <- data.frame(ages[1:2], act.p, dead.p, dorm.p, viab.p, act.dorm.p)
```

### E. Simple Linear regression
```{r}
# Regression model
fit <- lm(log10(act.p) ~ age, data = ages)
summary(fit)

# Plot activity against age
par(mar = c(5, 6, 4, 2))
plot(ages$age, act.p, log = "y", ylim = c(0.001, 0.5), xlim = c(-0.1, 90), 
     xlab = expression(paste("Age")), cex.lab = 1.5,
     ylab = NA,
     xaxt = "n", yaxt = "n",
     pch = 22, bg = "red", col = "black", cex = 2)
mtext("Proportion Active", side = 2, line = 4, cex = 1.5)
axis(side=1, at = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90), las=1) 
axis(side=2, at = c(0, 0.005, 0.05, 0.5), las=1)

# Add regression line
newage <- seq(min(ages$age), max(ages$age), 1)
regline <- predict(fit, newdata = data.frame(age = newage))
regline <- 10^(regline)
lines(newage, regline, lwd = 2)

# Add 95% confidence intervals
conf95 <- predict(fit, newdata = data.frame(age = newage),
                  interval = c("confidence"), level = 0.95, type = "response")
conf95 <- 10^(conf95)
matlines(newage, conf95[, c("lwr", "upr")], type="l", lty = 2, lwd = 2, col = "black")
```

# From here on, just initial try at multiple regression. 
fit <- lm(log10(act.p) ~ age + gender + last.show + show.freq + show.leng + pet + anti + ecze + alle + tan + etoh, data = ages)

# Package for multiple correspondence analysis (MCA)
require(glmulti)
continuous.pred <- data.frame(ages$age, PC1)
scaled <- scale(continuous.pred)
scaled <- as.dataframe(scaled)
fit2 <- lm(log10(act.p) ~ ages.age + PC1, data = scaled)

#glmulti <- glmulti((log10(act.p) ~ -1 + ages$age + gender + last.show + show.freq + show.leng + anti + ecze + pet + alle + tan + etoh))
glmulti <- glmulti((log10(act.p) ~ -1 + ages$age + show.freq))
