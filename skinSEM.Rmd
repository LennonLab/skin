---
title: "SkinFlora"
author: "Donald R. Schoolmaster Jr"
date: "July 16, 2015"
header-includes:
  - \usepackage{graphicx}
output: pdf_document
---

The goal of this analysis is to create an SEM of relative distribtion of active, dormant and dead components of skin flora. We begin with some basic demographic and behavioral variables and cell counts for each person. 
The initial model is that demography (i.e. age in this case) can have direct effects on the distrubtion of cells status as well as indirect effects mediatied through behaviors and environement. 
I had to make a decision about how to represent the relationship between the activity categories and the total, should the categories point at the total, or total at the categories? I decided that the exogenous processes set the total cell number, once there, the cells could change activity status. Thus, I pointed the arrows from total to each category. 

\includegraphics[width= .75\textwidth]{../out2.pdf}

This implies a set of smple models:
```{r}
#read in data 
ages.raw <- read.table("../skin.age.txt", sep = "\t", header = TRUE)
#remove subject "G1"
ages <- ages.raw[ ! ages.raw$subject == "G1", ]
#create dummy variables for multinomial variables
#shower frequency
show.f2<-ifelse(ages$show.freq==2,1,0)
show.f3<-ifelse(ages$show.freq==3,1,0)
#shower length
show.l2<-ifelse(ages$show.leng==2,1,0)
show.l3<-ifelse(ages$show.leng==3,1,0)
#last shower
show.last2<-ifelse(ages$last.show==2,1,0)
show.last3<-ifelse(ages$last.show==3,1,0)
#create new data.frame with all goodies.
ages.2<-data.frame(ages[,c(1:6,11:16)],show.f2,show.f3,show.l2,show.l3,show.last2,show.last3)
#set up a design matrix that we might use later
X<-as.matrix(cbind(rep(1,37),ages.2[,-c(1,3:5)]))
```

Fit models for each category

```{r}
#Active
summary(f.act<-lm(log(ages$active)~.,data=data.frame(X[,-1])))
#Dormant
summary(f.dor<-lm(log(ages$dormant)~.,data=data.frame(X[,-1])))
#Dead
summary(f.ded<-lm(log(ages$dead)~.,data=data.frame(X[,-1])))
#Total
summary(f.tot<-lm(log(ages$total)~.,data=data.frame(X[,-c(1,3)])))
#Residual correlation
cor(data.frame(active=resid(f.act),dormant=resid(f.dor),dead=resid(f.ded)))
```

Do logistic regression on each of the behavioral/environmental variables

```{r}
#set up list for results
pred.fits<-list()
#fit models
for(i in 1:12)pred.fits[[i]]<-glm(X[,i+3]~X[,2],data=data.frame(X),family=binomial)
#print fits
for(i in 1:12)print(summary(pred.fits[[i]]))
#which ones have sig age effect?
colnames(X)[which(sapply(pred.fits,function(x)summary(x)$coef[2,"Pr(>|z|)"])<0.052)+3]
#for shower length 15<x<30 calculate Tjur's R^2
mean(predict(pred.fits[[10]],type='response')[which(show.l3==1)])-
  mean(predict(pred.fits[[10]],type='response')[which(show.l3==0)])
```
Collecting the significant effects (except age->etoh) into a single graph gives

\includegraphics[width= .75\textwidth]{../NewOut.pdf}

If we were going to use a stepwise method to simplify the models...(we would have to defend this choice if were were going to use it)

```{r}
f.act2<-step(f.act,direction = 'both', trace=F)
f.dor2<-step(f.dor,direction = 'both', trace=F)
f.ded2<-step(f.ded,direction = 'both', trace=F)
f.tot2<-step(f.tot,direction = 'both', trace=F)
```

```{r}
#active2
summary(f.act2)
#dormant2
summary(f.dor2)
#dead2
summary(f.ded2)
#total2
summary(f.tot2)
```

Some neat stuff here. 
1. Showering including and antibiotic (negative coef) variables show up in the best dormant model
2. antibiotic (negative coef) shows up in the dead model
3) age shows up in the total cell count model with a coef that is almost identical to what we find for the active model (-0.020).
